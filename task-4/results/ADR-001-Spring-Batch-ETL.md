# ADR-001: Использование Spring Batch для ETL операций

## Название задачи: 
Внедрение пакетной обработки данных для решения проблем производительности TradeWare

## Автор:
Rinat Muhamedgaliev

## Дата:
2024-12-19

## Функциональные требования

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|1|Сотрудник склада|Загрузка отчета по остаткам|Сотрудник загружает CSV-файл с данными об остатках товаров через веб-интерфейс|
|2|Система валидации|Проверка формата данных|Система проверяет корректность формата загруженного CSV-файла|
|3|Spring Batch Job|Обработка данных|Пакетная обработка данных: чтение CSV, обновление справочной информацией, запись в БД|
|4|Система мониторинга|Отслеживание выполнения|Мониторинг статуса выполнения задач и сбор метрик производительности|
|5|Пользователь|Получение уведомления|Уведомление о завершении обработки или ошибках|

## Нефункциональные требования

|**№**|**Требование**|
| :-: | :- |
|1|Производительность: обработка 2000 строк за ≤ 30 секунд|
|2|Масштабируемость: поддержка 100-150 параллельных загрузок|
|3|Надежность: retry-механизмы для обработки ошибок|
|4|Мониторинг: централизованный сбор логов и метрик|
|5|Отказоустойчивость: возможность восстановления после сбоев|
|6|Совместимость: интеграция с существующей Java-экосистемой|

## Решение

### Архитектурное решение

Выбрано решение на основе **Spring Batch** для реализации ETL-операций в TradeWare. Spring Batch интегрируется в существующую Java-экосистему и решает ключевые проблемы производительности.

### C4 Диаграмма архитектуры

**Контекстная диаграмма:**
- Сотрудник склада взаимодействует с веб-приложением для загрузки отчетов
- Веб-приложение передает файлы в Spring Batch для обработки
- Spring Batch обрабатывает данные и обновляет базы данных

**Диаграмма контейнеров:**
- **Web Application** (Angular) - интерфейс для загрузки файлов
- **API Gateway** (Java/Spring Boot) - прием и валидация файлов
- **Spring Batch Service** (Java/Spring Batch) - ETL обработка данных
- **PostgreSQL** - хранение номенклатуры и справочных данных
- **Google Cloud Storage** - хранение загруженных файлов
- **Monitoring Stack** (Prometheus/Grafana) - мониторинг и логирование

### Обоснование выбора Spring Batch

**Преимущества:**
1. **Пакетная обработка**: Оптимизированная обработка больших объемов данных
2. **Транзакционность**: Гарантии ACID для критически важных операций
3. **Масштабируемость**: Chunk-based processing для эффективного использования ресурсов
4. **Retry/Skip механизмы**: Встроенная обработка ошибок и восстановление
5. **Мониторинг**: Интеграция с Spring Boot Actuator для метрик
6. **Совместимость**: Нативная интеграция с Java/Spring экосистемой
7. **Гибкость**: Возможность настройки под различные сценарии обработки

**Логика принятия решений:**
- Spring Batch решает проблему построчной обработки данных
- Chunk-based processing позволяет обрабатывать данные пакетами (например, по 1000 записей)
- Встроенные механизмы retry и skip обеспечивают надежность
- Интеграция с Spring Boot упрощает мониторинг и развертывание
- Возможность горизонтального масштабирования через Spring Cloud Data Flow

## Альтернативы

### 1. Apache Spark
**Преимущества:**
- Высокая производительность для больших данных
- Поддержка различных источников данных
- Горизонтальное масштабирование

**Недостатки:**
- Сложность настройки и администрирования
- Избыточность для текущих объемов данных (400K строк/день)
- Необходимость изучения новой технологии командой

### 2. Apache Airflow
**Преимущества:**
- Мощный оркестратор для сложных пайплайнов
- Визуальный интерфейс для мониторинга
- Поддержка различных типов задач

**Недостатки:**
- Избыточная сложность для простых ETL операций
- Дополнительная инфраструктура для развертывания
- Кривая обучения для команды

### 3. Custom Java Solution
**Преимущества:**
- Полный контроль над логикой обработки
- Минимальные внешние зависимости

**Недостатки:**
- Необходимость реализации retry/skip механизмов
- Отсутствие встроенного мониторинга
- Высокие затраты на разработку и поддержку

## Недостатки, ограничения, риски

### Недостатки Spring Batch
1. **Сложность настройки**: Требует глубокого понимания фреймворка
2. **Память**: Chunk-based processing может потреблять значительную память
3. **Однопоточность по умолчанию**: Требует дополнительной настройки для параллельной обработки

### Ограничения
1. **Объем данных**: Spring Batch оптимален для средних объемов данных (до 1M записей за раз)
2. **Real-time обработка**: Не подходит для обработки в реальном времени
3. **Сложные трансформации**: Ограниченные возможности для сложной бизнес-логики

### Риски
1. **Производительность**: Неправильная настройка chunk size может снизить производительность
2. **Мониторинг**: Необходимость настройки дополнительных инструментов мониторинга
3. **Масштабирование**: Вертикальное масштабирование может быть ограничено ресурсами сервера

### Меры по снижению рисков
1. **Тестирование производительности**: Нагрузочное тестирование с различными chunk sizes
2. **Мониторинг**: Настройка Prometheus/Grafana для отслеживания метрик
3. **Документация**: Подробная документация по настройке и администрированию
4. **Обучение команды**: Проведение обучения по Spring Batch для команды разработки
